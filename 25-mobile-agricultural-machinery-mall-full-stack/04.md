# 04-Koa2

> çœŸå®é¡¹ç›® -> æ•°æ® -> åç«¯ -> æŸ¥è¯¢æ•°æ®åº“ -> æ•°æ®è¿”å›ç»™åç«¯ -> åç«¯å“åº”å›å‰ç«¯ã€‚æ‰€ä»¥è¿™ç”¨çš„å¯ä¸æ˜¯ mock æ•°æ®ï¼Œå› æ­¤è¿™èŠ‚è¯¾å°±æ¥è®²è®²åç«¯çš„çŸ¥è¯†ï¼

## â˜…Koa å®‰è£…

- å®‰è£… nodeï¼š<https://nodejs.org/zh-cn/>
- <https://koa.bootcss.com/>
- Koa ä¾èµ– node v7.6.0 æˆ– ES2015 åŠæ›´é«˜ç‰ˆæœ¬å’Œ async æ–¹æ³•æ”¯æŒ
- `npm init -y`
- `npm i koa --save`
- Hello World

1ï¼‰è¯¾ç¨‹å®‰æ’

è¿™èŠ‚è®²koa2 -> ä¸‹èŠ‚MongoDB -> ä¸‹ä¸‹èŠ‚ï¼ŒæŠŠå­¦åˆ°çš„koa2+MongoDBçŸ¥è¯†å®Œæ•´åœ°åº”ç”¨åœ¨æˆ‘ä»¬çš„é¡¹ç›®é‡Œè¾¹

2ï¼‰Koa

> Koa -- åŸºäº Node.js å¹³å°çš„ä¸‹ä¸€ä»£ web å¼€å‘æ¡†æ¶

1ã€Koaæ¦‚è¿°

nodejsè¿™ä¸ªå¹³å° -> å¯ä»¥è®©JS è¿è¡Œåœ¨æœåŠ¡ç«¯ -> å¯çœ‹ä½œæ˜¯åŒçº§åˆ«çš„ -> Node.js ç¯å¢ƒä¸‹çš„JSã€Pythonã€Phpï¼Œæ¯•ç«Ÿå®ƒä»¬éƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªç½‘ç«™çš„åç«¯å»å¼€å‘å“ˆï¼

Koa æ˜¯ä¸€ä¸ªæ–°çš„ web æ¡†æ¶ï¼Œç”± Express å¹•åçš„åŸç­äººé©¬æ‰“é€ ï¼Œ
è‡´åŠ›äºæˆä¸º web åº”ç”¨å’Œ API å¼€å‘é¢†åŸŸä¸­çš„ä¸€ä¸ªæ›´å°ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›ã€æ›´å¥å£®çš„åŸºçŸ³ã€‚

é€šè¿‡åˆ©ç”¨ async å‡½æ•°ï¼ŒKoa å¸®ä½ ä¸¢å¼ƒå›è°ƒå‡½æ•°ï¼Œå¹¶æœ‰åŠ›åœ°å¢å¼ºé”™è¯¯å¤„ç†ã€‚
Koa å¹¶æ²¡æœ‰æ†ç»‘ä»»ä½•ä¸­é—´ä»¶ï¼Œè€Œæ˜¯æä¾›äº†ä¸€å¥—ä¼˜é›…çš„æ–¹æ³•ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè€Œæ„‰å¿«åœ°ç¼–å†™æœåŠ¡ç«¯åº”ç”¨ç¨‹åºã€‚

2ã€ä¸ºå•¥é€‰æ‹©Koa2ï¼Ÿè€Œä¸æ˜¯expressï¼Ÿ

koaåŒexpresséƒ½æ˜¯åŒä¸€ä¸ªå…¬å¸å¼€å‘çš„ï¼Œè€Œç°åœ¨çš„koaæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå³1å’Œ2ï¼Œæ˜¾ç„¶ç”¨æœ€æ–°çš„2å“ˆï¼

3ã€åŸºäºkoaçš„ï¼Œæœ‰ä¸¤ä¸ªä¼ä¸šçº§æ¡†æ¶ï¼Ÿ

- é˜¿é‡Œï¼š[egg - Born to build better enterprise frameworks and apps](https://eggjs.org/)
- 360ï¼š[ThinkJS - ä½¿ç”¨ ES6/7 ç‰¹æ€§å¼€å‘ Node.js é¡¹ç›®ï¼Œæ”¯æŒ TypeScript](https://thinkjs.org/)

å¦‚æœæŒæ¡å¥½koaçš„åŸºç¡€çŸ¥è¯†ï¼Œé‚£ä¹ˆä»¥ä¸Šé‚£ä¸¤ä¸ªæ¡†æ¶ï¼Œå­¦èµ·æ¥æ˜¯å¾ˆç®€å•çš„!

4ã€å®‰è£…koaï¼Ÿ

koaæ˜¯åŸºäºnodeï¼Œæ‰€ä»¥éœ€è¦å®‰è£…nodeï¼Œnodeçš„å®‰è£…è·¯å¾„ï¼Œç”¨é»˜è®¤çš„æˆ–è€…è‡ªå®šä¹‰çš„æ— ä¸­æ–‡è·¯å¾„ï¼

nodeç‰ˆæœ¬æ”¯æŒï¼š7.6.0åŠä»¥ä¸Šï¼Œä¸ç„¶ï¼Œä½ å°±å‡çº§å§ï¼

koaæ˜¯è„±ç¦»æˆ‘ä»¬è¿™ä¸ªå‰ç«¯é¡¹ç›®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶å `yarn init -y` ä¸€ä¸‹

``` bash
cd am-shop
mkdir src/koa2
cd src/koa2
yarn init -y
yarn add koa
```

å®‰è£…å¥½åï¼Œå°±å†™ä¸ªHello Worldï¼ï¼ˆå½“ä½ ä½¿ç”¨ä¸€ä¸ªæ–°ä¸œè¥¿çš„æ—¶å€™ï¼Œä½ éƒ½å¾—å†™ä¸ªHello Worldï¼ï¼‰

requireæ–¹æ³•ï¼Œæ˜¯Node.js æ——ä¸‹åŠ è½½æ¨¡å—çš„æ–¹æ³•

è€Œè¿™ç§æ¨¡å—è§„èŒƒæ˜¯CommonJS è§„èŒƒ

æ¨¡å—åŒ–å¼€å‘ï¼Œæœ‰å¾ˆå¤šè§„èŒƒï¼Œå¦‚ï¼š

- requirejs -> amdè§„èŒƒ
- seajs -> cmdè§„èŒƒ
- es6è§„èŒƒ
- node -> CommonJS è§„èŒƒ

nodeæœåŠ¡éœ€è¦é€šè¿‡å‘½ä»¤è¡Œæ¥æ‰§è¡Œï¼Œå¯ä¸æ˜¯åœ¨æµè§ˆå™¨æ‰§è¡Œjsæ–‡ä»¶


## â˜…async await

- Js å¼‚æ­¥æ“ä½œè§£å†³æ–¹æ¡ˆ
- async å‡½æ•°è¿”å› Promise å¯¹è±¡
- await åªèƒ½åœ¨ async å‡½æ•°å†…éƒ¨ä½¿ç”¨

1ï¼‰å¼‚æ­¥è§£å†³æ–¹æ¡ˆ

- ES6ï¼špromiseã€generator
- ES7ï¼šasyncã€await

åœ¨koa1é‡Œè¾¹ï¼Œgeneratorç”¨å¾—æ¯”è¾ƒå¤šï¼Œè€Œkoa2åˆ™æ˜¯asyncå’Œawaitäº†

- asyncå‡½æ•°è¿”å›çš„æ˜¯promiseå¯¹è±¡
- è¦è·å–promiseçš„å€¼ï¼Œç”¨thenæ–¹æ³•
- ä¸€èˆ¬æ¥è¯´ï¼Œasyncå’Œawaitæ˜¯é…åˆèµ·æ¥ä½¿ç”¨çš„
- asyncå’Œawaitçš„ä½œç”¨ -> awaitç­‰å¾…å¼‚æ­¥ä»»åŠ¡ç»“æŸï¼Œæ‰ä¼šèµ°æ¥ä¸‹æ¥çš„åŒæ­¥ä»£ç 


## â˜…get/post è¯·æ±‚æ¥æ”¶

- get & post åŒºåˆ«
- query & querystring åŒºåˆ«
  - queryï¼šè¿”å›çš„æ˜¯æ ¼å¼åŒ–å¥½çš„å‚æ•°å¯¹è±¡
  - querystringï¼šè¿”å›çš„æ˜¯è¯·æ±‚å­—ç¬¦ä¸²
- get æ¥æ”¶å‚æ•°
- post æ¥æ”¶å‚æ•°

- koa-bodyparser
- `npm i koa-bodyparser --save`

1ï¼‰å¦‚ä½•ç”¨koaå®ç°ä¸€ä¸ªgetå’Œpostè¯·æ±‚ï¼Ÿ

1ã€getå‘è¯·æ±‚ï¼Œkoaå¦‚ä½•æ¥æ”¶è¯·æ±‚ä»¥åŠå¦‚ä½•æ‹¿åˆ°å‚æ•°ï¼Ÿ

``` js
app.use(ctx => {
  let url = ctx.url;
  let query = ctx.query; // å¯¹è±¡
  let queryString = ctx.querystring; // å­—ç¬¦ä¸²

  ctx.body = {
    url,
    query,
    queryString
  };
});
```

![getè¯·æ±‚](assets/img/2020-02-28-15-52-09.png)

> æ³¨æ„keyå€¼æ˜¯å”¯ä¸€çš„ï¼Œå¦‚æœå‚æ•°è¿™æ ·çš„ `xxx=15&xxx=16`ï¼Œé‚£ä¹ˆåè¾¹çš„xxx 16å°±ä¼šè¦†ç›–æ‰å‰è¾¹çš„xxx 15
> 
> ctxæ˜¯ä¸ªå½¢å‚ï¼Œkoaä¼šä¼ ä¸ªå‚æ•°è¿‡æ¥ä½œä¸ºå®å‚ï¼Œé‡Œè¾¹æœ‰å¾ˆå¤šä¿¡æ¯ï¼Œå¦‚è¯·æ±‚çš„æ˜¯æ–¹æ³•ï¼Ÿè¯·æ±‚å¤´æ˜¯æ€æ ·çš„ï¼Ÿç­‰ç­‰ï¼Œæ€»ä¹‹å®ƒæ˜¯ä¸Šä¸‹æ–‡ï¼Œ
> 
> `localhost:3000?username=xiao` -> æµè§ˆå™¨è‡ªåŠ¨è¡¥`/` -> `localhost:3000/?username=xiao`

2ã€é‚£postå‘¢ï¼Ÿ

> ç¨å¾®éº»çƒ¦ç‚¹

1. åˆ›å»ºä¸€ä¸ªhtmlé¡µé¢ï¼Œé‡Œè¾¹æœ‰ä¸ªformè¡¨å•
2. action -> æœåŠ¡å™¨åœ°å€ï¼›method -> å’©æœ‰sï¼Œå³ä¸æ˜¯methodsï¼Œä¸ç„¶ï¼Œå‘çš„æ˜¯getè¯·æ±‚ï¼Œé‚£ä¹ˆè¾“å…¥çš„è¡¨å•æ•°æ®éƒ½åœ¨urlé‚£é‡Œäº†
3. åç«¯æ¥æ”¶å‰ç«¯å‘é€çš„postè¯·æ±‚ï¼Œå¦‚è¡¨å•ï¼Œéƒ½æ˜¯é€šè¿‡nameå±æ€§æ¥æ”¶çš„ï¼
4. ä¸ç®¡æ˜¯getè¿˜æ˜¯postè¯·æ±‚ï¼Œå¿…é¡»è¦æœ‰ `ctx.body`ï¼Œä¸ç„¶ä¼šæŠ¥404é”™è¯¯
5. å¿…é¡»è¦è§£ç ï¼Œä¸ç„¶ï¼Œä¼ è¿‡æ¥çš„æ•°æ®æœ‰ä¸­æ–‡çš„è¯ï¼Œæ˜¯æœ‰é—®é¢˜çš„
6. login.html ï¼ˆ`http://127.0.0.1:5500/src/koa2/login.html`ï¼‰-> å‘é€è¯·æ±‚ -> è¿”å›é¡µé¢çš„url `http://localhost:3000/`ï¼ˆä¸actionå¯¹åº”ï¼‰
7. æ‹¿åˆ°çš„æ˜¯ `username=123456&password=dada` è¿™æ ·æ ¼å¼çš„æ•°æ®ï¼Œä½†è¿™æ ·çš„æ•°æ®å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„å“ˆï¼æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸­é—´ä»¶æ¥å¤„ç†è¿™æ ·çš„æ•°æ®ï¼

3ã€koa-bodyparserï¼Ÿ

æ ¼å¼åŒ–`username=123456&password=dada`è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¸Œæœ›æ‹¿åˆ°å¯¹è±¡æ ¼å¼çš„æ•°æ®ï¼Ÿ

å®‰è£…ï¼š

``` bash
yarn add koa-bodyparser
```

æœ‰äº†è¿™ä¸ªä¸­é—´ä»¶ï¼Œé’ˆå¯¹äºpostè¯·æ±‚æ¥è¯´ï¼Œå¯ä»¥è®©æˆ‘ä»¬å°‘å†™å¾ˆå¤šä»£ç ï¼Œå¦‚ä¸éœ€è¦ç›‘å¬äº†ï¼Œä¸éœ€è¦è§£ç äº†ç­‰ç­‰

``` js
// æ²¡æœ‰koa-bodyparserï¼Œkoaæ‹¿åˆ°çš„è¡¨å•æ•°æ®
'username=123456&password=daada'

// æœ‰koa-bodyparseråã€‚æ‹¿åˆ°çš„è¡¨å•æ•°æ®
{"username":"123456","password":"daada"}
```

> æœ¬è´¨æ˜¯æ´‹è‘±æ¨¡å‹

4ã€æˆ‘æƒ³æŸ¥çœ‹ctxçš„å€¼ï¼Ÿ

æ§åˆ¶å°æ‰“å°äº†ctxçš„å€¼ï¼Œä½†æ˜¯è¿™å¹¶ä¸å¥½é˜…è¯»ï¼Œäºæ˜¯æˆ‘æŠŠå¯¹è±¡å€¼ç›´æ¥é€šè¿‡ `ctx.body`è¿”å›ç»™å‰ç«¯ï¼Œè¿™æ ·å¾—åˆ°çš„å¯¹è±¡å€¼å°±æ˜¯JSONæ ¼å¼çš„æ•°æ®ï¼Œç„¶åå†ç”¨JSONå·¥å…·æ’ä»¶æ ¼å¼åŒ–å°±å¥½äº†

``` js
app.use(async ctx => {
  console.log(ctx)
  let data = ctx.request.body;
  ctx.body = ctx;
});
```

![ctxçš„ç»“æ„](assets/img/2020-02-28-17-45-53.png)

## â˜…koa-router

- `npm i koa-router --save`
- é…ç½®è·¯ç”±
- è·¯ç”±å‰ç¼€ prefix
- ä¼ å‚

1ï¼‰åç«¯è·¯ç”±

åŒå‰ç«¯è·¯ç”±ä¸€æ ·ï¼Œéƒ½æ˜¯å¯¹urlè¿›è¡Œå¤„ç†

å®‰è£…ï¼š

``` bash
yarn add koa-router
```

> è¿™äº›åŒ…ï¼Œåœ¨é¡¹ç›®ä¸Šçº¿åè¿˜æ˜¯è¦ç”¨çš„å“ˆï¼çªç„¶æœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åç«¯ä»£ç éœ€è¦æ‰“åŒ…å—ï¼Ÿ

**â¹ï¼š**[ä¸ºä»€ä¹ˆä¸æŠŠåç«¯ä¹Ÿäº¤ç»™ webpackï¼Ÿ - V2EX](https://www.v2ex.com/t/476935)

**â¹ï¼š**[jaredpalmer/backpack: ğŸ’ Backpack is a minimalistic build system for Node.js projects.](https://github.com/jaredpalmer/backpack)


å…³äºè®²è¯¾ï¼š

- æœ‰äº›ä»£ç å‘½åï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºè¿™ä¸ªä¸œè¥¿çš„ç”¨æ³•è€Œå·²ï¼Œä¸è¦çº ç»“ï¼Œå¦‚ä½¿ç”¨koa-routerï¼Œéšä¾¿å®šä¹‰ä¸€ä¸ªå«`/abc`çš„è·¯ç”±ï¼Œè€Œè¿™æ ·çš„è·¯ç”±æ˜¾ç„¶åœ¨çœŸå®é¡¹ç›®é‡Œè¾¹æ˜¯æ²¡æœ‰çš„ï¼Œä½†ä¸ºäº†æ¼”ç¤ºè¿™ä¸ªåŒ…çš„ç”¨æ³•ï¼Œå°±ç®€å•éšæ„å®šä¹‰ä¸ªè·¯ç”±æ¼”ç¤ºä¸€ä¸‹å°±å¥½äº†
- å¾ˆå¤šæ—¶å€™åªä¼šè®²åº”ç”¨å±‚é¢çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯åº•å±‚çš„ä¸œè¥¿ï¼Œå¦‚vueåŸç†ã€koaåŸç†ä»€ä¹ˆçš„

æµ‹è¯•ä»£ç é‡Œè¾¹çš„ç»†èŠ‚ï¼š

- `app.use(router.routes())` -> `router.routes()`è¡¨ç¤ºå¯ä»¥é…å¾ˆå¤šä¸ªè·¯ç”±







## â˜…cookie

![cookie](assets/img/2020-02-28-11-43-25.png)

## â˜…æ¨¡æ¿ ejs

- `npm i koa-views --save`
- `npm i ejs --save`

## â˜…æ‰©å±•é˜…è¯»

- [ä½ çœŸçš„æ‡‚å‰åç«¯åˆ†ç¦»å—ï¼Ÿ - äº‘+ç¤¾åŒº - è…¾è®¯äº‘](https://cloud.tencent.com/developer/article/1160815)
- [å¦‚ä½•éƒ¨ç½²å‰ç«¯ä»£ç ](https://www.shymean.com/article/%E5%A6%82%E4%BD%95%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81)